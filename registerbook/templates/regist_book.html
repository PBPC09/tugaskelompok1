{% extends 'base.html' %}

{% block meta %}
    <title>Seller Page</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href='https://cdn.jsdelivr.net/npm/boxicons@2.0.5/css/boxicons.min.css' rel='stylesheet'>

    <style>
        * {
            font-family: 'Poppins', sans-serif;
        }

        .accordion-button {
            background-color: #f8f9fa;
        }

        .accordion-item.show .accordion-button {
            background-color: #e9ecef;
        }

        .accordion-item.show .btn-remove {
            display: inline-block;
        }

        #ratingFilter {
            background-color: whitesmoke;
            width: 150px;
            display: inline-block;
        }

        .card-header {
            position: relative;
        }

        .add-book-btn {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .book-card {
            border: 1px solid #ccc;     
            padding: 10px;  
            border-radius: 5px;
            display: flex;
            flex-direction: column; 
            height: 100%; 
        }

        .book-details {
            display: none;
        }

        .show-detail-text {
            color: #888;
            cursor: pointer;
            text-decoration: underline;
        }

        .card-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }
    </style>
{% endblock meta %}

{% block content %}
{% include "navbarseller.html" %}

<div class="container mt-5">
    <h1>Your Book Collection</h1>
    <div class="mb-3">
        <label for="ratingFilter" class="form-label">Filter by Rating:</label>
        <select id="ratingFilter" class="form-control w-auto">
            <option value="">All Ratings</option>
            <option value="gt4">> 4.0</option>
            <option value="lte4">â‰¤ 4.0</option>
        </select>
    </div>    
    <div class="row card-container align-items-stretch">
        <div id="product_table" class="row"></div>
    </div>
</div>

<div class="toast" role="alert" aria-live="assertive" aria-atomic="true" id="toastMessage" style="position: absolute; top: 0; right: 0;">
    <div class="toast-header">
      <strong class="mr-auto">Notification</strong>
      <button type="button" class="ml-2 mb-1 close" data-bs-dismiss="toast" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="toast-body">
      Default message
    </div>
</div>

<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Add New Book</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form" onsubmit="return false;">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="title" class="col-form-label">Title:</label>
                        <input type="text" class="form-control" id="title" name="title"></input>
                    </div>
                    <div class="mb-3">
                        <label for="author" class="col-form-label">Author:</label>
                        <input type="text" class="form-control" id="author" name="author"></input>
                    </div>
                    <div class="mb-3">
                        <label for="rating" class="col-form-label">Rating:</label>
                        <input type="number" class="form-control" id="rating" name="rating"></input>
                    </div>
                    <div class="mb-3">
                        <label for="voters" class="col-form-label">Voters:</label>
                        <input type="number" class="form-control" id="voters" name="voters"></input>
                    </div>
                    <div class="mb-3">
                        <label for="price" class="col-form-label">Price:</label>
                        <input type="number" class="form-control" id="price" name="price"></input>
                    </div>
                    <div class="mb-3">
                        <label for="currency" class="col-form-label">Currency:</label>
                        <input type="text" class="form-control" id="currency" name="currency"></input>
                    </div>
                    <div class="mb-3">
                        <label for="publisher" class="col-form-label">Publisher:</label>
                        <input type="text" class="form-control" id="publisher" name="publisher"></input>
                    </div>
                    <div class="mb-3">
                        <label for="page_count" class="col-form-label">Page Count:</label>
                        <input type="number" class="form-control" id="page_count" name="page_count"></input>
                    </div>
                    <div class="mb-3">
                        <label for="genres" class="col-form-label">Genres:</label>
                        <input type="text" class="form-control" id="genres" name="genres"></input>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="col-form-label">Description:</label>
                        <textarea class="form-control" id="description" name="description"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="button_add" data-bs-dismiss="modal">Add Book</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="bookDetailModal" tabindex="-1" aria-labelledby="bookDetailLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookDetailLabel">Book Description</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="bookDescriptionContent">
                <!-- Description will be filled dynamically here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="d-flex justify-content-center align-items-center" style="height: 10vh;">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">Add Book</button>
</div>

{% include "footer.html" %}

<script>
    $(document).ready(function() {
        $(".show-detail-text").click(function() {
            var bookId = $(this).data("book-id");
            $(".book-details[data-book-id='" + bookId + "']").slideToggle();
        });

        $(".add-to-cart-button").click(function() {
            var bookId = $(this).data("book-id");
            $("#id_book_id").val(bookId);
            $("#cartModal").modal("show");
        });
    });

    async function getBooks() {
        const ratingFilter = document.getElementById("ratingFilter").value;
        const url = `{% url 'registerbook:get_book_json' %}?rating_filter=${ratingFilter}`;
        return fetch(url).then((res) => res.json());
    }

    async function refreshBooks() {
        const container = document.getElementById("product_table");
        container.innerHTML = "";

        const books = await getBooks();

        books.forEach((book) => {
            const card = `
                <div class="col-md-4 mb-4">
                    <div class="accordion" id="accordionExample-${book.pk}">
                        <div class="book-card">
                            <div class="accordion-item">
                                <h3 class="accordion-header">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${book.pk}" aria-expanded="false" aria-controls="collapse${book.pk}">
                                        ${book.fields.title}
                                    </button>
                                </h3>
                                <div id="collapse${book.pk}" class="accordion-collapse collapse" data-bs-parent="#accordionExample-${book.pk}">
                                    <div class="accordion-body">
                                        <strong>Author:</strong> ${book.fields.author} <br/>
                                        <strong>Rating:</strong> ${book.fields.rating} <br/>
                                        <strong>Voters:</strong> ${book.fields.voters} <br/>
                                        <strong>Price:</strong> ${book.fields.price} ${book.fields.currency} <br/>
                                        <strong>Publisher:</strong> ${book.fields.publisher} <br/>
                                        <strong>Page Count:</strong> ${book.fields.page_count} <br/>
                                        <strong>Genres:</strong> ${book.fields.genres} <br/>
                                        <div class="float-end mb-2">
                                            <button class="btn btn-info btn-sm mt-2" data-description="${book.fields.description.replace(/"/g, '&quot;')}" onclick="event.stopPropagation(); showBookDescriptionFromData(this);">Details</button>
                                            <button class="btn btn-danger btn-sm mt-2 ml-2" onclick="event.stopPropagation(); removeItem(${book.pk})">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML += card;
        });
    }

    function addBook() {
        fetch("{% url 'registerbook:add_book_ajax' %}", {
            method: "POST",
            body: new FormData(document.querySelector('#form'))
        }).then(refreshBooks)

        document.getElementById("form").reset()
        return false
    }

    // Implementasi AJAX DELETE
    function removeItem(bookId) {
        if (confirm("Are you sure you want to delete this item?")) {
            fetch(`delete-book-ajax/${bookId}/`, {
                method: "DELETE",
            }).then(refreshBooks)
        }
        return false;
    }


    function showBookDescriptionFromData(buttonElement) {
        const description = buttonElement.getAttribute("data-description");
        document.getElementById("bookDescriptionContent").innerText = description;
        const bookDetailModal = new bootstrap.Modal(document.getElementById('bookDetailModal'));
        bookDetailModal.show();
    }

    refreshBooks();
    document.getElementById("button_add").onclick = addBook
    document.getElementById("ratingFilter").addEventListener("change", refreshBooks);
    document.getElementById("logout-button").addEventListener("click", function() {
        window.location.href = "{% url 'main:logout' %}";
    });
</script>
{% endblock %}